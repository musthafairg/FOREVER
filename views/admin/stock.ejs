<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FOREVER. Admin Stock</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/admin.css" />
  </head>

  <body>
    <header class="admin-header">
      <div class="logo">FOREVER<span class="dot">.</span></div>
      <a href="/admin/logout" class="logout-button">Logout</a>
    </header>

    <div class="main-layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <nav class="sidebar-nav">
          <ul>
            <li>
              <a href="/admin"
                ><i class="fas fa-tachometer-alt"></i>Dashboard</a
              >
            </li>
            <li>
              <a href="/admin/users"><i class="fas fa-users"></i>Users</a>
            </li>
            <li>
              <a href="/admin/category"
                ><i class="fas fa-folder-open"></i>Category</a
              >
            </li>
            <li>
              <a href="/admin/products"><i class="fas fa-list"></i>Products</a>
            </li>
            <li>
              <a href="/admin/orders"><i class="fas fa-box"></i>Orders</a>
            </li>
            <li >
                    <a href="/admin/sales-report"><i class="fas fa-chart-line"></i>Sales Report</a> 
                </li>
            <li class="active">
              <a href="/admin/stock"><i class="fas fa-boxes"></i>Stock</a>
            </li>
            <li>
              <a href="/admin/offers/product"
                ><i class="fa-solid fa-tags"></i>Product Offer</a
              >
            </li>
            <li>
              <a href="/admin/offers/category"
                ><i class="fa-solid fa-tags"></i>Category Offer</a
              >
            </li>
            <li>
              <a href="/admin/coupons"
                ><i class="fa-solid fa-ticket"></i>Coupons</a
              >
            </li>
          </ul>
        </nav>
      </aside>

      <!-- CONTENT -->
      <main class="dashboard-content">
        <!-- HEADER -->
        <div class="content-header d-flex justify-content-between mb-3">
          <h2 class="content-title">Stock Management</h2>
        </div>

        <!-- SEARCH (SAME AS USERS PAGE) -->
        <header class="card-header text-center mb-4">
          <form method="get" class="d-inline w-100">
            <div
              class="input-group input-group-sm border border-1 border-secondary rounded-pill mx-auto"
              style="max-width: 500px"
            >
              <input
                type="text"
                class="form-control border-0 rounded-pill"
                placeholder="Search product..."
                name="search"
                value="<%= search || '' %>"
              />

              <button class="btn border-0">
                <i class="fas fa-search"></i>
              </button>

              <% if (search) { %>
              <a href="/admin/stock" class="btn border-0 text-danger fw-bold"
                >x</a
              >
              <% } %>
            </div>
          </form>
        </header>

        <!-- TABLE -->
        <div class="table-container bg-white p-3 rounded shadow-sm">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Product</th>
                <th>Stock</th>
                <th>Status</th>
                <th width="200">Action</th>
              </tr>
            </thead>

            <tbody>
              <% if (products.length > 0) { %> <% products.forEach(p => { %>
              <tr>
                <td><%= p.productName %></td>

                <td>
                  <span id="qty-<%= p._id %>"><%= p.quantity %></span>
                </td>

                <td>
                  <span
                    id="status-<%= p._id %>"
                    class="badge <%= p.status === 'Available' ? 'bg-success' : 'bg-danger' %>"
                  >
                    <%= p.status %>
                  </span>
                </td>

                <td>
                  <div class="d-flex gap-2">
                    <input
                      type="number"
                      min="0"
                      class="form-control form-control-sm"
                      id="input-<%= p._id %>"
                      value="<%= p.quantity %>"
                    />

                    <button
                      class="btn btn-dark btn-sm"
                      onclick="updateStock('<%= p._id %>')"
                    >
                      Update
                    </button>
                  </div>

                  <small class="text-danger" id="error-<%= p._id %>"></small>
                </td>
              </tr>
              <% }) %> <% } else { %>
              <tr>
                <td colspan="4" class="text-center">No products found</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>

        <!-- PAGINATION (SAME STYLE AS USERS PAGE) -->
        <div class="container mt-4">
          <nav>
            <ul class="pagination justify-content-center">
              <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a
                  class="page-link"
                  href="/admin/stock?page=<%= i %><%= search ? '&search=' + search : '' %>"
                >
                  <%= i %>
                </a>
              </li>
              <% } %>
            </ul>
          </nav>
        </div>
      </main>
    </div>

    <script>
      async function updateStock(id) {
        const qty = Number(document.getElementById(`input-${id}`).value)
        const errorEl = document.getElementById(`error-${id}`)
        errorEl.innerText = ''

        const res = await fetch(`/admin/stock/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: qty })
        })

        const data = await res.json()

        if (!data.success) {
          errorEl.innerText = data.errors?.quantity || 'Update failed'
          return
        }

        document.getElementById(`qty-${id}`).innerText = data.quantity
        document.getElementById(`status-${id}`).innerText = data.status
        document.getElementById(`status-${id}`).className =
          'badge ' + (data.status === 'Available' ? 'bg-success' : 'bg-danger')
      }
    </script>
  </body>
</html>
