<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= product.productName %> | Forever</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/product-details.css" />

    <script src="/js/header.js" defer></script>
  </head>
  <body>
    <%- include('../partials/user/header.ejs') %> <% let totalStock = 0; if
    (product.variants && product.variants.length > 0) { for (let i = 0; i <
    product.variants.length; i++) { totalStock += product.variants[i].quantity;
    } } const isUnavailable = product.isBlocked || product.status !==
    "Available" || totalStock <= 0; %>

    <main class="main">
      <div class="page-header breadcrumb-wrap">
        <div class="container">
          <div class="breadcrumb">
            <a href="/" rel="nofollow">Home</a>
            <span></span>
            <a href="/shop" rel="nofollow">Shop</a>

            <span></span>
            <a href="/product-details?id=<%= product._id %>" rel="nofollow"
              ><%= product.productName%></a
            >
          </div>
        </div>
      </div>

      <section class="mt-50 mb-50">
        <div class="container">
          <div class="row">
            <div class="col-lg-9">
              <div class="product-detail accordion-detail">
                <div class="row mb-50">
                  <div class="col-md-6 col-sm-12">
                    <div class="detail-gallery">
                      <div class="product-image-slider">
                        <div class="zoom-container" id="zoomContainer">
                          <% if (product.productImage &&
                          product.productImage.length > 0) { %>

                          <figure class="border-radius-10">
                            <img
                              id="mainImage"
                              class="zoom-image"
                              src="/uploads/image/<%=product.productImage[0]%>"
                              alt="Product Image"
                            />
                          </figure>

                          <% } %>
                        </div>
                      </div>

                      <div class="col-md-6">
                        <div class="zoom-result" id="zoomResult"></div>
                      </div>

                      <div class="slider-nav-thumbnails pl-15 pr-15">
                        <% if (product.productImage) { %> <%
                        product.productImage.forEach(img => { %>
                        <div>
                          <img
                            style="object-fit: contain"
                            src="/uploads/image/<%= img %>"
                            onclick="changeMainImage(this.src)"
                            alt="Thumbnail"
                          />
                        </div>
                        <% }) %> <% } %>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6 col-sm-12">
                    <div class="detail-info">
                      <h2 class="title-detail"><%= product.productName %></h2>

                      <div class="product-detail-rating">
                        <% if (product.avgRating > 0) { %> <% for (let i=1;
                        i<=Math.floor(product.avgRating); i++){%>
                        <span class="rating-badge">
                          <i class="fa-solid fa-star text-warning"></i>
                        </span>
                        <%}%> <% } else { %>
                        <span>No ratings yet</span>
                        <% } %>

                        <div class="product-rate-cover text-end">
                          <span class="font-small ml-5 text-muted"
                            >( <%=product.reviews.length%> reviews)</span
                          >
                        </div>
                      </div>

                      <div class="clearfix product-price-cover mt-10">
                        <div class="product-price primary-color float-left">
                          <span id="dynamicPrice" class="text-brand">
                            ₹ <%= offerData.finalPrice %>
                          </span>

                          <% if (offerData.discountPercent > 0) { %>
                          <span
                            id="dynamicOldPrice"
                            class="old-price font-md ml-15"
                          >
                            ₹ <%= offerData.originalPrice %>
                          </span>
                          <% } else { %>
                          <span id="dynamicOldPrice"></span>
                          <% } %>

                          <span
                            id="dynamicDiscount"
                            class="save-price font-md color3 ml-15"
                          >
                            <% if (offerData.discountPercent > 0) { %> <%=
                            offerData.discountPercent %>% OFF <% } %>
                          </span>
                        </div>

                        <% if (offerData.discountPercent > 0) { %>
                        <small class="text-muted d-block mt-1">
                          Applied <%= offerData.appliedOffer %> Offer
                        </small>
                        <% } %>
                      </div>

                      <div class="bt-1 border-color-1 mt-15 mb-15"></div>

                      <% if (product?.variants?.length) { %>
                      <div class="product-size mb-30">
                        <label class="mr-10">Size:</label>

                        <div class="size-options">
                          <% product.variants.forEach(variant => { %>
                          <button
                            type="button"
                            class="size-btn"
                            data-size="<%= variant.size %>"
                          >
                            <%= variant.size %>
                          </button>
                          <% }) %>
                        </div>

                        <input type="hidden" id="selectedSize" name="size" />
                      </div>
                      <% } %>

                      <div class="short-desc mb-30">
                        <p><%= product.description %></p>
                      </div>

                      <div class="product_sort_info font-xs mb-30">
                        <ul>
                          <li class="mb-10">1 Year Brand Warranty</li>
                          <li class="mb-10">30 Day Return Policy</li>
                          <li>Cash on Delivery available</li>
                        </ul>
                      </div>

                      <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                      <div class="detail-extralink">
                        <div
                          class="detail-qty border radius"
                          style="<%= isUnavailable ? 'opacity:0.6;pointer-events:none;' : '' %>"
                        >
                          <a href="#" class="qty-down"
                            ><i class="fa-solid fa-angle-down"></i
                          ></a>
                          <span class="qty-val" id="quantity">1</span>
                          <a href="#" class="qty-up"
                            ><i class="fa-solid fa-angle-up"></i
                          ></a>
                        </div>

                        <div class="product-extra-link2">
                          <% if (isUnavailable) { %>

                          <button
                            class="button-add-to-cart"
                            disabled
                            style="opacity: 0.6; cursor: not-allowed"
                          >
                            Out of Stock
                          </button>

                          <% } else { %>

                          <button
                            type="button"
                            class="button-add-to-cart"
                            id="addToCartBtn"
                            data-product-id="<%= product._id %>"
                            data-stock="<%= totalStock %>"
                          >
                            Add to Cart
                          </button>

                          <% } %>

                          <button
                            type="button"
                            aria-label="Add To Wishlist"
                            class="action-btn hover-up"
                            id="wishlistBtn"
                            data-product-id="<%= product._id %>"
                          >
                            <i class="fa-regular fa-heart"></i>
                          </button>
                        </div>
                      </div>

                      <ul class="product-meta font-xs color-grey mt-50">
                        <li class="mb-5">
                          Stock Code: <a href="#">FWM15VKT</a>
                        </li>
                        <li class="mb-5">
                          Tags:
                          <a href="#" rel="tag"
                            ><%= product.category?.name %></a
                          >
                        </li>
                        <li>
                          <% if (!isUnavailable) { %>

                          <span class="in-stock text-success ml-5">
                            <%= totalStock %> Items in Stock
                          </span>

                          <% } else { %>

                          <span class="text-danger ml-5">Out of Stock</span>

                          <% } %>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="container-spec">
                  <div class="card-section mt-5">
                    <h4>Highlights</h4>
                    <ul class="highlights-list">
                      <% if (product.highlights.length > 0) { %> <%
                      product.highlights.forEach(h => { %>
                      <li><%= h %></li>
                      <% }) %> <% } else { %>
                      <li>High quality build</li>
                      <li>Premium design</li>
                      <% } %>
                    </ul>
                  </div>

                  <div class="reviews-section mt-5">
                    <h3 class="section-title">Customer Reviews</h3>

                    <div class="row g-4">
                      <!-- REVIEWS LIST -->
                      <div class="col-md-7">
                        <% if (latestreviews.length > 0) { %> <%
                        latestreviews.forEach(r => { %>

                        <div class="review-card">
                          <div class="review-header">
                            <div class="review-avatar">
                              <%= (r.user?.name || "U")[0].toUpperCase() %>
                            </div>

                            <div>
                              <strong class="review-name">
                                <%= r.user?.name || "User" %>
                              </strong>

                              <div class="review-stars">
                                <% for (let i = 1; i <= 5; i++) { %>
                                <i
                                  class="fa-solid fa-star <%= i <= r.rating ? 'active' : '' %>"
                                ></i>
                                <% } %>
                              </div>
                            </div>
                          </div>

                          <% if (r.comment) { %>
                          <p class="review-text"><%= r.comment %></p>
                          <% } %>
                        </div>

                        <% }) %> <% } else { %>
                        <p class="no-review-text">No reviews yet.</p>
                        <% } %>
                      </div>

                      <!-- WRITE REVIEW -->
                      <div class="col-md-5">
                        <div class="write-review-card">
                          <h4 class="mb-3">Write a Review</h4>

                          <form action="/product/add-review" method="POST">
                            <input
                              type="hidden"
                              name="productId"
                              value="<%= product._id %>"
                            />

                            <label class="form-label">Rating</label>
                            <select name="rating" class="form-select" required>
                              <option value="5">★★★★★ Excellent</option>
                              <option value="4">★★★★☆ Good</option>
                              <option value="3">★★★☆☆ Average</option>
                              <option value="2">★★☆☆☆ Poor</option>
                              <option value="1">★☆☆☆☆ Very Bad</option>
                            </select>

                            <label class="form-label mt-3">Comment</label>
                            <textarea
                              name="comment"
                              class="form-control"
                              rows="3"
                              placeholder="Share your experience..."
                            ></textarea>

                            <button class="btn btn-dark mt-3 w-100">
                              Submit Review
                            </button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="related-products-section">
            <h3 class="mt-5 mb-3">Related Products</h3>

            <div class="row related-products">
              <% relatedProducts.forEach(p => { %>
              <div class="col-md-2 col-6">
                <a
                  href="/product-details?id=<%= p._id %>"
                  class="text-decoration-none text-dark"
                >
                  <div class="related-product-card">
                    <img
                      src="/uploads/image/<%= p.productImage[0] %>"
                      class="img-fluid mb-2"
                      style="width: 240px; height: 240px"
                    />
                    <p style="font-size: 14px"><%= p.productName %></p>
                    <strong>₹ <%= p.regularPrice %></strong>
                  </div>
                </a>
              </div>
              <% }) %>
            </div>
          </div>
        </div>
      </section>
    </main>

    <%- include('../partials/user/footer.ejs') %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>



      const variants = <%- JSON.stringify(product.variants) %>;
    </script>

    <script src="/js/product-details.js"></script>
  </body>
</html>
